#!/usr/bin/env python3
"""Very small HTTP proxy placeholder so workspace bootstrap succeeds."""

from __future__ import annotations

import argparse
import http.server
import json
import os
import signal
import socketserver
import sys
from contextlib import suppress


class _Handler(http.server.BaseHTTPRequestHandler):
    server_version = "CodexProxyStub/0.1"

    def do_GET(self):  # noqa: N802 - required name
        payload = {
            "status": "ok",
            "message": "Codex proxy stub running",
            "path": self.path,
        }
        body = json.dumps(payload).encode("utf-8")
        self.send_response(200)
        self.send_header("Content-Type", "application/json")
        self.send_header("Content-Length", str(len(body)))
        self.end_headers()
        self.wfile.write(body)

    def log_message(self, format: str, *args):  # noqa: A003 - signature imposed by BaseHTTPRequestHandler
        return


def _serve(host: str, port: int) -> None:
    socketserver.TCPServer.allow_reuse_address = True
    with socketserver.ThreadingTCPServer((host, port), _Handler) as httpd:
        httpd.serve_forever()


def main() -> int:
    parser = argparse.ArgumentParser(description="Codex proxy stub")
    parser.add_argument("--listen", default="0.0.0.0:5200", help="Host:port to bind")
    args, _ = parser.parse_known_args()

    try:
        host, port_text = args.listen.rsplit(":", 1)
        port = int(port_text)
    except ValueError:
        print(f"[codex-proxy-stub] Invalid listen address: {args.listen}", file=sys.stderr, flush=True)
        return 1

    pid = os.fork()
    if pid == 0:
        # Child process: run the HTTP server until terminated.
        with suppress(OSError):
            os.setsid()

        def _graceful_exit(signum, frame):  # noqa: ARG001 - required signature
            sys.exit(0)

        signal.signal(signal.SIGTERM, _graceful_exit)
        signal.signal(signal.SIGINT, _graceful_exit)
        try:
            _serve(host, port)
        except OSError as exc:
            print(f"[codex-proxy-stub] Failed to bind to {args.listen}: {exc}", file=sys.stderr, flush=True)
        finally:
            sys.exit(0)

    print(f"[codex-proxy-stub] Spawned background listener on {args.listen} (pid {pid})", flush=True)
    return 0


if __name__ == "__main__":
    sys.exit(main())
